export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);

    // --- API è·¯ç”±å¤„ç† ---

    // 1. è®¿å®¢è®°å½• API
    if (url.pathname === '/api/visit') {
      const geo = request.cf || {};
      const city = geo.city || 'æœªçŸ¥åŸå¸‚';
      const country = geo.country || 'æœªçŸ¥å›½å®¶';
      const lat = geo.latitude || '34.0522';
      const lon = geo.longitude || '-118.2437';
      
      try {
        if (env.KV) {
          const visits = (await env.KV.get('visits', { type: 'json' })) || [];
          visits.unshift({ city, country, lat, lon, time: new Date().toISOString() });
          if (visits.length > 50) visits.pop();
          await env.KV.put('visits', JSON.stringify(visits));
        }
        return new Response(JSON.stringify({ city, country, lat, lon }), { headers: { 'Content-Type': 'application/json' } });
      } catch (e) {
        return new Response(JSON.stringify({ city: 'æœ¬åœ°', country: 'å¼€å‘ç¯å¢ƒ', lat: 0, lon: 0 }), { headers: { 'Content-Type': 'application/json' } });
      }
    }

    // 2. AIåŠ©æ‰‹ API (ä¼˜åŒ–é…ç½®)
    if (url.pathname === '/api/ai' && request.method === 'POST') {
      try {
        const { message, thinking } = await request.json();
        if (!message) return new Response(JSON.stringify({ error: 'æ¶ˆæ¯ä¸èƒ½ä¸ºç©º' }), { status: 400, headers: { 'Content-Type': 'application/json' } });

        const apiKey = env.OPENROUTER_API_KEY;
        if (!apiKey) return new Response(JSON.stringify({ error: 'APIå¯†é’¥æœªé…ç½®' }), { status: 500, headers: { 'Content-Type': 'application/json' } });

        const systemPrompt = thinking ? 
          'ä½ æ˜¯äººæ–‡ç¤¾ç§‘é¢†åŸŸçš„å­¦æœ¯åŠ©æ‰‹ï¼Œä½¿ç”¨æ·±åº¦æ€è€ƒæ¨¡å¼åˆ†æé—®é¢˜ï¼Œç»™å‡ºä¸“ä¸šã€é€»è¾‘ä¸¥å¯†çš„å›ç­”ã€‚è¯·åŠ¡å¿…å®Œæ•´å›ç­”ï¼Œä¸è¦ä¸­é€”æˆªæ–­ã€‚' :
          'ä½ æ˜¯äººæ–‡ç¤¾ç§‘é¢†åŸŸçš„å­¦æœ¯åŠ©æ‰‹ï¼Œæä¾›å‡†ç¡®ã€ç®€æ´çš„å›ç­”ã€‚';

        const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json',
            'HTTP-Referer': request.headers.get('referer') || 'https://academic-guide.pages.dev',
            'X-Title': 'äººæ–‡ç¤¾ç§‘å­¦æœ¯å¯¼è§ˆ'
          },
          body: JSON.stringify({
            model: 'stepfun/step-3.5-flash:free',
            messages: [
              { role: 'system', content: systemPrompt },
              { role: 'user', content: message }
            ],
            temperature: thinking ? 0.7 : 0.9,
            max_tokens: 4096 
          })
        });

        if (!response.ok) throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);

        const data = await response.json();
        let responseContent = data.choices[0].message.content;
        if (thinking) responseContent = `ğŸ§  **æ·±åº¦æ€è€ƒæ¨¡å¼**\n\n${responseContent}`;
        
        return new Response(JSON.stringify({ response: responseContent }), { headers: { 'Content-Type': 'application/json' } });
      } catch (e) {
        return new Response(JSON.stringify({ error: 'AIæœåŠ¡æš‚æ—¶ä¸å¯ç”¨' }), { status: 500, headers: { 'Content-Type': 'application/json' } });
      }
    }

    // 3. æ ‘æ´ç•™è¨€ API
    if (url.pathname === '/api/messages') {
      try {
        const msgs = (await env.KV.get('messages', { type: 'json' })) || [];
        return new Response(JSON.stringify(msgs), { headers: { 'Content-Type': 'application/json' } });
      } catch (e) { return new Response('[]', { headers: { 'Content-Type': 'application/json' } }); }
    }

    if (url.pathname === '/api/post' && request.method === 'POST') {
      try {
        const { text } = await request.json();
        if (!text || text.length > 200) return new Response('å†…å®¹ä¸åˆæ³•', { status: 400 });
        const msgs = (await env.KV.get('messages', { type: 'json' })) || [];
        msgs.unshift({ text, time: new Date().toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai' }) });
        if (msgs.length > 30) msgs.pop(); 
        await env.KV.put('messages', JSON.stringify(msgs));
        return new Response('OK');
      } catch (e) { return new Response('Error', { status: 500 }); }
    }

    // 4. ç®¡ç†å‘˜åˆ é™¤ç•™è¨€ API (æ–°å¢)
    if (url.pathname === '/api/admin/clear-messages' && request.method === 'POST') {
      try {
        const { password } = await request.json();
        const adminPassword = env.ADMIN_PASSWORD;
        
        if (!adminPassword) {
          return new Response(JSON.stringify({ error: 'æœåŠ¡ç«¯æœªé…ç½®ç®¡ç†å¯†ç ' }), { status: 500, headers: { 'Content-Type': 'application/json' } });
        }
        
        if (password === adminPassword) {
          await env.KV.put('messages', JSON.stringify([]));
          return new Response(JSON.stringify({ success: true }), { headers: { 'Content-Type': 'application/json' } });
        } else {
          return new Response(JSON.stringify({ error: 'å¯†ç é”™è¯¯' }), { status: 403, headers: { 'Content-Type': 'application/json' } });
        }
      } catch (e) { 
        return new Response(JSON.stringify({ error: 'æ“ä½œå¤±è´¥' }), { status: 500, headers: { 'Content-Type': 'application/json' } }); 
      }
    }

    // --- é¡µé¢æ¸²æŸ“é€»è¾‘ ---
    
    // å®Œæ•´ç«™ç‚¹æ•°æ®
    const sites = [
      // ç»¼åˆå­¦æœ¯
      { name: "ä¸­å›½çŸ¥ç½‘ (CNKI)", url: "https://www.cnki.net", desc: "ä¸­å›½æœ€å¤§æœ€æƒå¨çš„å­¦æœ¯èµ„æºé›†æˆå¹³å°ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "æ ¸å¿ƒæ•°æ®åº“" },
      { name: "ä¸‡æ–¹æ•°æ®", url: "https://www.wanfangdata.com.cn", desc: "å¤§å‹ç»¼åˆæ€§å­¦æœ¯ä¿¡æ¯æœåŠ¡å¹³å°ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "æ ¸å¿ƒæ•°æ®åº“" },
      { name: "ç»´æ™®èµ„è®¯", url: "http://www.cqvip.com", desc: "ä¸­æ–‡ç§‘æŠ€æœŸåˆŠèµ„æºæœåŠ¡å¹³å°ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "æ ¸å¿ƒæ•°æ®åº“" },
      { name: "å›½å®¶å“²å­¦ç¤¾ä¼šç§‘å­¦æ–‡çŒ®ä¸­å¿ƒ", url: "https://www.ncpssd.org", desc: "å›½å®¶çº§å…¬ç›Šæ€§ç¤¾ç§‘å¹³å°ï¼Œæµ·é‡å…è´¹æœŸåˆŠã€‚", category: "ç»¼åˆå­¦æœ¯", level: "å®˜æ–¹å¹³å°" },
      { name: "å›½å®¶å“²å­¦ç¤¾ä¼šç§‘å­¦å­¦æœ¯æœŸåˆŠåº“", url: "https://www.nssd.cn", desc: "ç²¾é€‰ç¤¾ç§‘æ ¸å¿ƒæœŸåˆŠå…¨æ–‡åº“ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "CSSCI" },
      { name: "Google Scholar", url: "https://scholar.google.com", desc: "å…¨çƒæœ€å¤§çš„å…è´¹å­¦æœ¯æœç´¢å¼•æ“ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "æƒå¨ç´¢å¼•" },
      { name: "ç™¾åº¦å­¦æœ¯", url: "https://xueshu.baidu.com", desc: "å›½å†…é¢†å…ˆçš„å­¦æœ¯èµ„æºæœç´¢å¹³å°ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "æœç´¢å¼•æ“" },
      { name: "JSTOR", url: "https://www.jstor.org", desc: "è¥¿æ–‡è¿‡åˆŠæ•°æ®åº“ï¼Œäººæ–‡ç¤¾ç§‘æ ¸å¿ƒã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SSCI Q1" },
      { name: "Project MUSE", url: "https://muse.jhu.edu", desc: "æƒå¨äººæ–‡ç¤¾ç§‘æœŸåˆŠæ•°æ®åº“ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SSCI Q1" },
      { name: "Web of Science", url: "https://www.webofscience.com", desc: "å…¨çƒæƒå¨å¼•æ–‡ç´¢å¼•(SSCI/A&HCI)ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SCI/SSCI" },
      { name: "Scopus", url: "https://www.scopus.com", desc: "Elsevierå¤§å‹æ–‡æ‘˜æ•°æ®åº“ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SCI/SSCI" },
      { name: "ScienceDirect", url: "https://www.sciencedirect.com", desc: "Elsevieræ ¸å¿ƒå…¨æ–‡æ•°æ®åº“ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SCI Q1" },
      { name: "SpringerLink", url: "https://link.springer.com", desc: "å…¨çƒé¢†å…ˆçš„STMå­¦æœ¯èµ„æºå¹³å°ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SCI Q1" },
      { name: "Taylor & Francis", url: "https://www.tandfonline.com", desc: "ä¸–ç•Œé¢†å…ˆçš„äººæ–‡ç¤¾ç§‘å‡ºç‰ˆç¤¾ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SSCI Q1" },
      { name: "SAGE Journals", url: "https://journals.sagepub.com", desc: "å›½é™…é¢†å…ˆçš„å­¦æœ¯æœŸåˆŠå‡ºç‰ˆå•†ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SSCI" },
      { name: "Wiley", url: "https://onlinelibrary.wiley.com", desc: "å…¨çƒå†å²æœ€æ‚ ä¹…çš„å­¦æœ¯å‡ºç‰ˆå•†ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "SCI/SSCI" },
      { name: "ProQuest", url: "https://www.proquest.com", desc: "å…¨çƒé¢†å…ˆçš„åšç¡•å£«è®ºæ–‡åº“ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "å­¦ä½è®ºæ–‡" },
      { name: "EBSCOhost", url: "https://www.ebsco.com", desc: "æä¾›å¹¿æ³›çš„å­¦æœ¯æ•°æ®åº“ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "ç»¼åˆæ•°æ®åº“" },
      { name: "DOAJ", url: "https://doaj.org", desc: "å¼€æ”¾è·å–æœŸåˆŠç›®å½•ã€‚", category: "ç»¼åˆå­¦æœ¯", level: "å¼€æ”¾è·å–" },
      { name: "ResearchGate", url: "https://www.researchgate.net", desc: "é¢å‘ç ”ç©¶å­¦è€…çš„ç¤¾äº¤ç½‘ç»œã€‚", category: "ç»¼åˆå­¦æœ¯", level: "å­¦æœ¯ç¤¾äº¤" },
      // å“²å­¦
      { name: "Stanford Encyclopedia of Philosophy", url: "https://plato.stanford.edu", desc: "æ–¯å¦ç¦å“²å­¦ç™¾ç§‘ï¼Œå­¦ç•Œæœ€æƒå¨ã€‚", category: "å“²å­¦", level: "æƒå¨ç™¾ç§‘" },
      { name: "Internet Encyclopedia of Philosophy", url: "https://www.iep.utm.edu", desc: "å…è´¹çš„å­¦æœ¯å“²å­¦èµ„æºã€‚", category: "å“²å­¦", level: "å¼€æ”¾è·å–" },
      { name: "PhilPapers", url: "https://philpapers.org", desc: "å“²å­¦æ–‡çŒ®ç´¢å¼•ä¸ç ”ç©¶ç¤¾åŒºã€‚", category: "å“²å­¦", level: "ä¸“ä¸šç´¢å¼•" },
      { name: "ä¸­å›½å“²å­¦ä¹¦ç”µå­åŒ–è®¡åˆ’", url: "https://ctext.org", desc: "ä¸­å›½å¤å…¸æ–‡çŒ®æ•°å­—åŒ–é¡¹ç›®ã€‚", category: "å“²å­¦", level: "å¤ç±æ•´ç†" },
      { name: "é©¬å…‹æ€ä¸»ä¹‰ç ”ç©¶ç½‘", url: "http://myy.cass.cn", desc: "ä¸­å›½ç¤¾ç§‘é™¢é©¬å…‹æ€ä¸»ä¹‰ç ”ç©¶é™¢ã€‚", category: "å“²å­¦", level: "å®˜æ–¹æœºæ„" },
      { name: "ä½›å­¦æ•°ä½å›¾ä¹¦é¦†", url: "https://buddhist.fhl.net", desc: "å°å¤§ä½›å­¦æ•°å­—å›¾ä¹¦é¦†ã€‚", category: "å“²å­¦", level: "ä¸“ä¸šæ•°æ®åº“" },
      { name: "é“æ•™æ–‡åŒ–èµ„æ–™åº“", url: "https://www.taoism.org.hk", desc: "é¦™æ¸¯é“æ•™æ–‡åŒ–èµ„æ–™åº“ã€‚", category: "å“²å­¦", level: "ä¸“ä¸šèµ„æ–™" },
      { name: "ä¸­å›½ç°è±¡å­¦ç½‘", url: "http://www.cnphenomenology.com", desc: "ç°è±¡å­¦ç ”ç©¶èµ„è®¯å¹³å°ã€‚", category: "å“²å­¦", level: "å­¦æœ¯ç¤¾åŒº" },
      { name: "Ethics Updates", url: "https://ethicsupdates.net", desc: "é“å¾·å“²å­¦æ•™å­¦ä¸ç ”ç©¶èµ„æºã€‚", category: "å“²å­¦", level: "æ•™å­¦èµ„æº" },
      { name: "Philosophy Documentation Center", url: "https://www.pdcnet.org", desc: "å“²å­¦æ–‡çŒ®ä¸­å¿ƒã€‚", category: "å“²å­¦", level: "æ–‡çŒ®ä¸­å¿ƒ" },
      { name: "ä¸­å›½çŸ¥ç½‘å“²å­¦åº“", url: "https://kns.cnki.net/kns8/defaultresult/index?kw=å“²å­¦", desc: "çŸ¥ç½‘å“²å­¦å­¦ç§‘æ–‡çŒ®ã€‚", category: "å“²å­¦", level: "æ ¸å¿ƒæœŸåˆŠ" },
      { name: "Britannica Philosophy", url: "https://www.britannica.com/browse/philosophy", desc: "å¤§è‹±ç™¾ç§‘å…¨ä¹¦å“²å­¦åˆ†ç±»ã€‚", category: "å“²å­¦", level: "ç™¾ç§‘å…¨ä¹¦" },
      { name: "David Hume Archives", url: "https://davidhume.org", desc: "ä¼‘è°Ÿè‘—ä½œåœ¨çº¿æ¡£æ¡ˆé¦†ã€‚", category: "å“²å­¦", level: "ä¸“é¢˜æ¡£æ¡ˆ" },
      { name: "Marxists Internet Archive", url: "https://www.marxists.org", desc: "é©¬å…‹æ€ä¸»ä¹‰è€…äº’è”ç½‘æ¡£æ¡ˆåº“ã€‚", category: "å“²å­¦", level: "å¼€æ”¾è·å–" },
      { name: "Notre Dame Philosophical Reviews", url: "https://ndpr.nd.edu", desc: "åœ£æ¯å¤§å­¦å“²å­¦è¯„è®ºã€‚", category: "å“²å­¦", level: "SSCI" },
      // ç»æµå­¦
      { name: "NBER", url: "https://www.nber.org", desc: "ç¾å›½å›½å®¶ç»æµç ”ç©¶å±€ï¼Œå·¥ä½œè®ºæ–‡æƒå¨ã€‚", category: "ç»æµå­¦", level: "é¡¶çº§æ™ºåº“" },
      { name: "IMF Data", url: "https://www.imf.org/en/Data", desc: "å›½é™…è´§å¸åŸºé‡‘ç»„ç»‡æ•°æ®ã€‚", category: "ç»æµå­¦", level: "å®˜æ–¹æ•°æ®" },
      { name: "World Bank Open Data", url: "https://data.worldbank.org", desc: "ä¸–ç•Œé“¶è¡Œå¼€æ”¾æ•°æ®åº“ã€‚", category: "ç»æµå­¦", level: "å®˜æ–¹æ•°æ®" },
      { name: "OECD Data", url: "https://data.oecd.org", desc: "ç»åˆç»„ç»‡ç»Ÿè®¡æ•°æ®ã€‚", category: "ç»æµå­¦", level: "å®˜æ–¹æ•°æ®" },
      { name: "EconLit", url: "https://www.aeaweb.org/econlit", desc: "ç¾å›½ç»æµå­¦ä¼šæ–‡çŒ®åº“ã€‚", category: "ç»æµå­¦", level: "æƒå¨ç´¢å¼•" },
      { name: "RePEc", url: "https://repec.org", desc: "ç»æµå­¦ç ”ç©¶è®ºæ–‡åº“ã€‚", category: "ç»æµå­¦", level: "å¼€æ”¾è·å–" },
      { name: "JSTOR Economics", url: "https://www.jstor.org/subject/economics", desc: "JSTORç»æµå­¦ç§‘åˆé›†ã€‚", category: "ç»æµå­¦", level: "SSCI Q1" },
      { name: "å›½ç ”ç½‘", url: "http://www.drcnet.com.cn", desc: "å›½åŠ¡é™¢å‘å±•ç ”ç©¶ä¸­å¿ƒä¿¡æ¯ç½‘ã€‚", category: "ç»æµå­¦", level: "å®˜æ–¹æ™ºåº“" },
      { name: "ä¸­ç»ç½‘ç»Ÿè®¡æ•°æ®åº“", url: "https://db.cei.cn", desc: "å›½å®¶ä¿¡æ¯ä¸­å¿ƒç»æµç»Ÿè®¡æ•°æ®ã€‚", category: "ç»æµå­¦", level: "æ ¸å¿ƒæ•°æ®" },
      { name: "ä¸­å›½ç»æµå­¦æ•™è‚²ç§‘ç ”ç½‘", url: "http://www.cenet.org.cn", desc: "ä¸­å›½ç»æµå­¦æœ¯äº¤æµå¹³å°ã€‚", category: "ç»æµå­¦", level: "å­¦æœ¯é—¨æˆ·" },
      { name: "FRED", url: "https://fred.stlouisfed.org", desc: "ç¾è”å‚¨ç»æµæ•°æ®åº“ã€‚", category: "ç»æµå­¦", level: "æƒå¨æ•°æ®" },
      { name: "Wind (ä¸‡å¾—)", url: "https://www.wind.com.cn", desc: "ä¸­å›½é‡‘èæ•°æ®æœåŠ¡å•†ã€‚", category: "ç»æµå­¦", level: "é‡‘èç»ˆç«¯" },
      { name: "CSMAR", url: "https://www.gtarsc.com", desc: "å›½æ³°å®‰ç»æµé‡‘èç ”ç©¶åº“ã€‚", category: "ç»æµå­¦", level: "ç ”ç©¶æ•°æ®" },
      { name: "The Economist", url: "https://www.economist.com", desc: "ç»æµå­¦äººæ‚å¿—ã€‚", category: "ç»æµå­¦", level: "é¡¶çº§æœŸåˆŠ" },
      { name: "Financial Times", url: "https://www.ft.com", desc: "é‡‘èæ—¶æŠ¥ã€‚", category: "ç»æµå­¦", level: "æƒå¨åª’ä½“" },
      { name: "å›½å®¶ç»Ÿè®¡å±€", url: "http://www.stats.gov.cn", desc: "ä¸­å›½å®˜æ–¹ç»Ÿè®¡æ•°æ®ã€‚", category: "ç»æµå­¦", level: "å®˜æ–¹æ•°æ®" },
      { name: "WTO Statistics", url: "https://stats.wto.org", desc: "ä¸–è´¸ç»„ç»‡ç»Ÿè®¡æ•°æ®åº“ã€‚", category: "ç»æµå­¦", level: "å®˜æ–¹æ•°æ®" },
      { name: "Bureau of Economic Analysis", url: "https://www.bea.gov", desc: "ç¾å›½ç»æµåˆ†æå±€ã€‚", category: "ç»æµå­¦", level: "å®˜æ–¹æ•°æ®" },
      { name: "Bureau of Labor Statistics", url: "https://www.bls.gov", desc: "ç¾å›½åŠ³å·¥ç»Ÿè®¡å±€ã€‚", category: "ç»æµå­¦", level: "å®˜æ–¹æ•°æ®" },
      { name: "Trading Economics", url: "https://tradingeconomics.com", desc: "å…¨çƒå®è§‚ç»æµæŒ‡æ ‡ã€‚", category: "ç»æµå­¦", level: "æ•°æ®å¹³å°" },
      // æ³•å­¦
      { name: "åŒ—å¤§æ³•å®", url: "https://www.pkulaw.com", desc: "ä¸­å›½æœ€å¤§çš„æ³•å¾‹ä¿¡æ¯æ£€ç´¢ç³»ç»Ÿã€‚", category: "æ³•å­¦", level: "æ ¸å¿ƒæ•°æ®åº“" },
      { name: "å¨ç§‘å…ˆè¡Œ", url: "https://law.wkinfo.com.cn", desc: "ä¸“ä¸šæ³•å¾‹æ£€ç´¢åº“ã€‚", category: "æ³•å­¦", level: "å•†ä¸šæ•°æ®åº“" },
      { name: "ä¸­å›½è£åˆ¤æ–‡ä¹¦ç½‘", url: "https://wenshu.court.gov.cn", desc: "æœ€é«˜æ³•è£åˆ¤æ–‡ä¹¦å…¬å¼€å¹³å°ã€‚", category: "æ³•å­¦", level: "å®˜æ–¹å¹³å°" },
      { name: "HeinOnline", url: "https://heinonline.org", desc: "å…¨çƒæœ€å¤§æ³•å­¦æœŸåˆŠåº“ã€‚", category: "æ³•å­¦", level: "SSCI" },
      { name: "Westlaw", url: "https://legal.thomsonreuters.com", desc: "æ±¤æ£®è·¯é€æ³•å¾‹æ•°æ®åº“ã€‚", category: "æ³•å­¦", level: "é¡¶çº§æ•°æ®åº“" },
      { name: "LexisNexis", url: "https://www.lexisnexis.com", desc: "å…¨çƒé¢†å…ˆæ³•å¾‹ä¿¡æ¯èµ„æºã€‚", category: "æ³•å­¦", level: "é¡¶çº§æ•°æ®åº“" },
      { name: "ä¸­å›½æ³•å­¦ç½‘", url: "https://www.iolaw.org.cn", desc: "ä¸­å›½ç¤¾ç§‘é™¢æ³•å­¦ç ”ç©¶æ‰€ã€‚", category: "æ³•å­¦", level: "å®˜æ–¹æœºæ„" },
      { name: "ä¸­å›½å®ªæ²»ç½‘", url: "http://www.calaw.cn", desc: "å®ªæ³•å­¦ç ”ç©¶å¹³å°ã€‚", category: "æ³•å­¦", level: "å­¦æœ¯é—¨æˆ·" },
      { name: "åŒ—å¤§æ³•æ„", url: "https://www.lawyee.org", desc: "åŒ—å¤§å®è¯æ³•åŠ¡ç ”ç©¶æ‰€ã€‚", category: "æ³•å­¦", level: "å­¦æœ¯æœºæ„" },
      { name: "Justia", url: "https://law.justia.com", desc: "å…è´¹æ³•å¾‹ä¿¡æ¯èµ„æºã€‚", category: "æ³•å­¦", level: "å¼€æ”¾è·å–" },
      { name: "FindLaw", url: "https://caselaw.findlaw.com", desc: "æ³•å¾‹æ¡ˆä¾‹ä¸ä¿¡æ¯ç½‘ç«™ã€‚", category: "æ³•å­¦", level: "ä¿¡æ¯é—¨æˆ·" },
      { name: "æ¬§æ´²äººæƒæ³•é™¢", url: "https://www.echr.coe.int", desc: "ECHRå®˜æ–¹æ–‡ä¹¦åº“ã€‚", category: "æ³•å­¦", level: "å›½é™…æ³•é™¢" },
      { name: "WTO Law", url: "https://www.wto.org/english/tratop_e/dispu_e/dispu_e.htm", desc: "WTOäº‰ç«¯è§£å†³æ–‡ä¹¦ã€‚", category: "æ³•å­¦", level: "å›½é™…æ³•" },
      { name: "ä¸­åäººæ°‘å…±å’Œå›½å¸æ³•éƒ¨", url: "http://www.moj.gov.cn", desc: "å¸æ³•éƒ¨å®˜ç½‘ã€‚", category: "æ³•å­¦", level: "æ”¿åºœæœºæ„" },
      { name: "æœ€é«˜äººæ°‘æ£€å¯Ÿé™¢", url: "https://www.spp.gov.cn", desc: "æœ€é«˜æ£€å®˜ç½‘ã€‚", category: "æ³•å­¦", level: "æ”¿åºœæœºæ„" },
      // æ•™è‚²å­¦
      { name: "ERIC", url: "https://eric.ed.gov", desc: "ç¾å›½æ•™è‚²éƒ¨æ•™è‚²å­¦æ–‡çŒ®åº“ã€‚", category: "æ•™è‚²å­¦", level: "æƒå¨ç´¢å¼•" },
      { name: "ProQuest Education Journals", url: "https://www.proquest.com/products-services/Education-Journals.html", desc: "æ•™è‚²æœŸåˆŠæ•°æ®åº“ã€‚", category: "æ•™è‚²å­¦", level: "æ ¸å¿ƒæ•°æ®åº“" },
      { name: "OECD Education", url: "https://www.oecd.org/education/", desc: "ç»åˆç»„ç»‡æ•™è‚²ç»Ÿè®¡ã€‚", category: "æ•™è‚²å­¦", level: "å®˜æ–¹æ•°æ®" },
      { name: "UNESCO Education", url: "https://en.unesco.org/themes/education", desc: "è”åˆå›½æ•™ç§‘æ–‡ç»„ç»‡ã€‚", category: "æ•™è‚²å­¦", level: "å›½é™…ç»„ç»‡" },
      { name: "ä¸­å›½æ•™è‚²éƒ¨", url: "https://www.moe.gov.cn", desc: "ä¸­å›½æ•™è‚²éƒ¨å®˜ç½‘ã€‚", category: "æ•™è‚²å­¦", level: "æ”¿åºœæœºæ„" },
      { name: "ä¸­å›½æ•™è‚²åœ¨çº¿", url: "https://www.eol.cn", desc: "ä¸­å›½æœ€å¤§æ•™è‚²é—¨æˆ·ä¹‹ä¸€ã€‚", category: "æ•™è‚²å­¦", level: "ä¿¡æ¯é—¨æˆ·" },
      { name: "å­¦ä¿¡ç½‘", url: "https://www.chsi.com.cn", desc: "å­¦å†æŸ¥è¯¢å®˜æ–¹å¹³å°ã€‚", category: "æ•™è‚²å­¦", level: "å®˜æ–¹å¹³å°" },
      { name: "Teachers College Record", url: "https://www.tcrecord.org", desc: "å“¥ä¼¦æ¯”äºšå¤§å­¦å¸ˆèŒƒå­¦é™¢æœŸåˆŠã€‚", category: "æ•™è‚²å­¦", level: "SSCI" },
      { name: "Education Week", url: "https://www.edweek.org", desc: "ç¾å›½æ•™è‚²æ–°é—»æƒå¨åª’ä½“ã€‚", category: "æ•™è‚²å­¦", level: "æƒå¨åª’ä½“" },
      { name: "ä¸­å›½çŸ¥ç½‘æ•™è‚²åº“", url: "https://kns.cnki.net/kns8/defaultresult/index?kw=æ•™è‚²", desc: "çŸ¥ç½‘æ•™è‚²å­¦æ–‡çŒ®ã€‚", category: "æ•™è‚²å­¦", level: "æ ¸å¿ƒæœŸåˆŠ" },
      // æ–‡å­¦/è¯­è¨€
      { name: "MLA International Bibliography", url: "https://www.mla.org/bibliography", desc: "ç°ä»£è¯­è¨€åä¼šæƒå¨ç´¢å¼•ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "æƒå¨ç´¢å¼•" },
      { name: "ä¸­å›½åŸºæœ¬å¤ç±åº“", url: "https://www.ancientbooks.cn", desc: "å¤§å‹å¤ç±æ•°æ®åº“ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "å¤ç±æ•´ç†" },
      { name: "æ±‰ç±ç”µå­æ–‡çŒ®èµ„æ–™åº“", url: "https://www.ihp.sinica.edu.tw", desc: "å°æ¹¾ä¸­ç ”é™¢å¤ç±åº“ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "å¤ç±æ•´ç†" },
      { name: "Project Gutenberg", url: "https://www.gutenberg.org", desc: "å¤ç™»å ¡è®¡åˆ’ï¼Œå…è´¹ç”µå­ä¹¦åº“ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "å¼€æ”¾è·å–" },
      { name: "Poetry Foundation", url: "https://www.poetryfoundation.org", desc: "è¯—æ­ŒåŸºé‡‘ä¼šï¼Œæµ·é‡è¯—æ­Œèµæã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "ä¸“ä¸šæœºæ„" },
      { name: "Internet Archive", url: "https://archive.org", desc: "äº’è”ç½‘æ¡£æ¡ˆé¦†ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "æ•°å­—æ¡£æ¡ˆ" },
      { name: "Open Library", url: "https://openlibrary.org", desc: "ç½‘é¡µå¼ä¹¦ç±å›¾ä¹¦é¦†ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "å¼€æ”¾è·å–" },
      { name: "ä¸­å›½è¯—æ­Œç½‘", url: "https://www.zgshige.com", desc: "ä¸­å›½ä½œåè¯—æ­Œç½‘ç«™ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "ä¸“ä¸šæœºæ„" },
      { name: "è¯­æ–™åº“åœ¨çº¿", url: "http://www.cncorpus.org", desc: "åŒ—äº¬å¤§å­¦è¯­æ–™åº“ç ”ç©¶ä¸­å¿ƒã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "ç ”ç©¶å·¥å…·" },
      { name: "BNC", url: "https://www.english-corpora.org/bnc/", desc: "è‹±å›½å›½å®¶è¯­æ–™åº“ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "ç ”ç©¶å·¥å…·" },
      { name: "COCA", url: "https://www.english-corpora.org/coca/", desc: "ç¾å›½å½“ä»£è‹±è¯­è¯­æ–™åº“ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "ç ”ç©¶å·¥å…·" },
      { name: "å½“ä»£æ–‡å­¦ç ”ç©¶", url: "http://www.ddwx.cn", desc: "å½“ä»£æ–‡å­¦ç ”ç©¶åˆŠç‰©ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "æ ¸å¿ƒæœŸåˆŠ" },
      { name: "ä¸­å›½ä½œå®¶ç½‘", url: "https://www.chinawriter.com.cn", desc: "ä¸­å›½ä½œå®¶åä¼šå®˜ç½‘ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "å®˜æ–¹æœºæ„" },
      { name: "Shakespeare Online", url: "https://www.shakespeareonline.com", desc: "èå£«æ¯”äºšåœ¨çº¿èµ„æºã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "ä¸“é¢˜èµ„æº" },
      { name: "å‰‘æ¡¥å¤§å­¦å›¾ä¹¦é¦†", url: "https://www.lib.cam.ac.uk", desc: "å‰‘æ¡¥å¤§å­¦æ•°å­—ç‰¹è—ã€‚", category: "æ–‡å­¦/è¯­è¨€", level: "æ•°å­—æ¡£æ¡ˆ" },
      // å†å²å­¦
      { name: "ä¸­åå¤ç±èµ„æºåº“", url: "https://www.nlc.cn/web/zu.shtml", desc: "ä¸­å›½å›½å®¶å›¾ä¹¦é¦†å¤ç±èµ„æºã€‚", category: "å†å²å­¦", level: "å›½å®¶å›¾ä¹¦é¦†" },
      { name: "ä¸­å›½åœ°æ–¹å¿—", url: "https://www.difangzhi.cn", desc: "ä¸­å›½åœ°æ–¹å¿—åŠå…¬å®¤ã€‚", category: "å†å²å­¦", level: "å®˜æ–¹æœºæ„" },
      { name: "æŠ—æ—¥æˆ˜äº‰æ–‡çŒ®å¹³å°", url: "https://www.modernhistory.org.cn", desc: "æŠ—æˆ˜æ—¶æœŸçè´µå²æ–™ã€‚", category: "å†å²å­¦", level: "ä¸“é¢˜æ¡£æ¡ˆ" },
      { name: "ä¸­å›½å†å²ç ”ç©¶é™¢", url: "https://www.cssn.cn/history", desc: "ä¸­å›½ç¤¾ç§‘é™¢å†å²ç ”ç©¶é™¢ã€‚", category: "å†å²å­¦", level: "å®˜æ–¹æœºæ„" },
      { name: "å›½å®¶åšç‰©é¦†", url: "https://www.chnmuseum.cn", desc: "ä¸­å›½å›½å®¶åšç‰©é¦†ã€‚", category: "å†å²å­¦", level: "å›½å®¶åšç‰©é¦†" },
      { name: "æ•…å®«åšç‰©é™¢", url: "https://www.dpm.org.cn", desc: "æ•…å®«æ•°å­—æ–‡ç‰©åº“ã€‚", category: "å†å²å­¦", level: "å›½å®¶åšç‰©é¦†" },
      { name: "HathiTrust", url: "https://www.hathitrust.org", desc: "å…¨çƒå¤§å­¦å›¾ä¹¦é¦†æ•°å­—åº“ã€‚", category: "å†å²å­¦", level: "æ•°å­—å›¾ä¹¦é¦†" },
      { name: "Perseus Digital Library", url: "https://www.perseus.tufts.edu", desc: "å¤å…¸å­¦æ•°å­—å›¾ä¹¦é¦†ã€‚", category: "å†å²å­¦", level: "æ•°å­—å›¾ä¹¦é¦†" },
      { name: "World Digital Library", url: "https://www.wdl.org", desc: "ä¸–ç•Œæ•°å­—å›¾ä¹¦é¦†ã€‚", category: "å†å²å­¦", level: "æ•°å­—å›¾ä¹¦é¦†" },
      { name: "Europeana", url: "https://www.europeana.eu", desc: "æ¬§æ´²æ–‡åŒ–é—äº§æ•°å­—å¹³å°ã€‚", category: "å†å²å­¦", level: "æ•°å­—æ¡£æ¡ˆ" }
    ];

    // å°†ç«™ç‚¹æ•°æ®æ³¨å…¥HTMLæ¨¡æ¿
    const htmlContent = `
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>äººæ–‡ç¤¾ç§‘å­¦æœ¯å¯¼è§ˆ - ä¸“ä¸šç‰ˆ</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* ========== åŸºç¡€æ ·å¼å˜é‡ ========== */
    :root {
      --bg-color: #ffffff;
      --bg-secondary: #f5f5f7;
      --text-primary: #1d1d1f;
      --text-secondary: #86868b;
      --accent-color: #0071e3;
      --card-bg: #ffffff;
      --border-color: #d2d2d7;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --font-main: -apple-system, BlinkMacSystemFont, "SF Pro Display", "Helvetica Neue", Arial, sans-serif;
      --favorite-color: #ff3b30;
    }

    [data-theme="dark"] {
      --bg-color: #000000;
      --bg-secondary: #1c1c1e;
      --text-primary: #f5f5f7;
      --text-secondary: #98989d;
      --accent-color: #0a84ff;
      --card-bg: #2c2c2e;
      --border-color: #38383a;
      --shadow: 0 4px 12px rgba(0,0,0,0.4);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-main);
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      transition: background 0.3s ease;
    }

    /* ========== å¯¼èˆªæ æ ·å¼ ========== */
    header {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: saturate(180%) blur(20px);
      position: sticky;
      top: 0;
      z-index: 999;
      border-bottom: 1px solid var(--border-color);
    }
    [data-theme="dark"] header { background: rgba(28, 28, 30, 0.8); }

    .nav-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-section {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, #1d1d1f, #0071e3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    [data-theme="dark"] .logo { background: linear-gradient(135deg, #f5f5f7, #0a84ff); -webkit-background-clip: text; }

    /* é¡¶éƒ¨AIæŒ‰é’® */
    .ai-header-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      background: linear-gradient(135deg, #0071e3, #5856d6);
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,113,227,0.3);
    }
    .ai-header-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,113,227,0.4);
    }

    /* å³ä¾§å·¥å…·æ  */
    .nav-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    /* ========== æ—¶é’Ÿç»„ä»¶æ ·å¼ ========== */
    .clocks-container {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 6px 12px;
      background: var(--bg-secondary);
      border-radius: 20px;
    }

    .clock-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: default;
    }

    .clock-face {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      position: relative;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
    }

    .hand {
      position: absolute;
      bottom: 50%;
      left: 50%;
      transform-origin: 50% 100%;
      border-radius: 2px;
    }

    .hour-hand { width: 2px; height: 7px; background: var(--text-primary); margin-left: -1px; }
    .minute-hand { width: 1.5px; height: 10px; background: var(--text-secondary); margin-left: -0.75px; }
    .second-hand { width: 0.5px; height: 12px; background: #ff3b30; margin-left: -0.25px; }
    .center-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 2px;
      height: 2px;
      background: var(--accent-color);
      border-radius: 50%;
      z-index: 5;
    }

    .clock-time {
      font-size: 9px;
      color: var(--text-secondary);
      font-weight: 500;
      font-variant-numeric: tabular-nums;
    }

    .clock-label {
      font-size: 8px;
      color: var(--text-secondary);
      opacity: 0.7;
    }

    /* ========== ä¸»å†…å®¹åŒºæ ·å¼ ========== */
    .hero-section {
      max-width: 800px;
      margin: 40px auto 30px;
      text-align: center;
      padding: 0 20px;
    }

    .quote-box {
      font-size: 18px;
      color: var(--text-secondary);
      margin-bottom: 30px;
      font-style: italic;
      min-height: 27px; 
    }

    .super-search {
      display: flex;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.12);
      overflow: hidden;
      border: 1px solid var(--border-color);
      transition: box-shadow 0.3s;
    }
    .super-search:focus-within {
      box-shadow: 0 8px 30px rgba(0,113,227,0.2);
      border-color: var(--accent-color);
    }

    .search-select {
      padding: 0 16px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      outline: none;
      border-right: 1px solid var(--border-color);
    }

    .search-input-main {
      flex: 1;
      padding: 18px 20px;
      border: none;
      background: transparent;
      font-size: 16px;
      color: var(--text-primary);
      outline: none;
    }

    .search-btn {
      padding: 0 24px;
      background: var(--accent-color);
      color: white;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
      transition: opacity 0.2s;
    }
    .search-btn:hover { opacity: 0.9; }

    /* ========== æ ‡ç­¾æ æ ·å¼ ========== */
    .tabs-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 24px 0;
      display: flex;
      overflow-x: auto;
      gap: 10px;
    }
    .tab-btn {
      padding: 8px 16px;
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn.active { background: var(--text-primary); color: var(--bg-color); border-color: transparent; }

    /* ========== ç½‘æ ¼å¸ƒå±€ ========== */
    main {
      max-width: 1200px;
      margin: 30px auto 60px;
      padding: 0 24px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 16px;
    }
    
    /* ========== å¡ç‰‡æ ·å¼ ========== */
    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid transparent;
      box-shadow: var(--shadow);
      text-decoration: none;
      color: inherit;
      display: flex;
      flex-direction: column;
      position: relative;
      transition: transform 0.2s;
    }
    .card:hover { transform: translateY(-3px); border-color: var(--accent-color); }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 6px;
    }
    
    .card-title { font-size: 15px; font-weight: 600; line-height: 1.3; flex: 1; }
    
    .card-fav-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px;
      margin-left: 8px;
      margin-top: -2px;
      transition: transform 0.2s;
    }
    .card-fav-btn svg { width: 18px; height: 18px; stroke: var(--text-secondary); fill: none; stroke-width: 2; }
    .card-fav-btn.active svg { fill: var(--favorite-color); stroke: var(--favorite-color); }
    .card-fav-btn:hover { transform: scale(1.2); }

    .card-level {
      display: inline-block;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0, 113, 227, 0.1);
      color: var(--accent-color);
      margin-bottom: 8px;
      font-weight: 600;
    }

    .card-desc { font-size: 12px; color: var(--text-secondary); flex: 1; margin-bottom: 8px; }
    .card-tag { font-size: 10px; color: var(--accent-color); opacity: 0.7; display: block; }

    /* ========== æ‚¬æµ®æŒ‰é’® ========== */
    .float-actions {
      position: fixed;
      bottom: 100px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 1000;
    }

    .float-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 24px;
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .float-btn:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .float-btn svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .ai-btn {
      background: linear-gradient(135deg, #0071e3, #5856d6);
      color: white;
      border: none;
    }

    /* ========== é¢æ¿æ ·å¼ ========== */
    .panel-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 1001;
      display: none;
      justify-content: flex-end;
    }
    .panel-overlay.active { display: flex; }

    .side-panel {
      width: 400px;
      height: 100%;
      background: var(--bg-color);
      box-shadow: -4px 0 20px rgba(0,0,0,0.1);
      padding: 24px;
      display: flex;
      flex-direction: column;
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .panel-overlay.active .side-panel { transform: translateX(0); }

    .panel-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .panel-title { font-size: 18px; font-weight: 700; }

    /* ========== AIèŠå¤©é¢æ¿æ ·å¼ ========== */
    .ai-chat-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .ai-chat-box {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 0 4px 16px 0;
      max-height: calc(100vh - 280px);
      scrollbar-width: thin;
      scrollbar-color: var(--border-color) transparent;
    }
    
    .ai-chat-box::-webkit-scrollbar { width: 6px; }
    .ai-chat-box::-webkit-scrollbar-track { background: transparent; }
    .ai-chat-box::-webkit-scrollbar-thumb {
      background-color: var(--border-color);
      border-radius: 3px;
    }

    /* æ€è€ƒæ¨¡å¼å¼€å…³ä¸ç®¡ç†æŒ‰é’®åŒºåŸŸ */
    .thinking-mode {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 13px;
    }
    
    .chat-controls {
        display: flex;
        gap: 8px;
    }
    
    .control-btn {
        background: none;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 2px 8px;
        font-size: 12px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
    }
    .control-btn:hover {
        border-color: var(--accent-color);
        color: var(--accent-color);
    }
    .control-btn.danger:hover {
        border-color: var(--favorite-color);
        color: var(--favorite-color);
    }

    .thinking-toggle {
      position: relative;
      width: 44px;
      height: 24px;
      background: var(--border-color);
      border-radius: 12px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .thinking-toggle.active { background: var(--accent-color); }

    .thinking-toggle::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    
    .thinking-toggle.active::after { transform: translateX(20px); }

    .thinking-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* ========== æ¶ˆæ¯æ ·å¼ ========== */
    .msg-item {
      background: var(--bg-secondary);
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 13px;
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
      position: relative;
    }
    
    /* åˆ é™¤å•æ¡æ¶ˆæ¯æŒ‰é’® */
    .msg-delete-btn {
        position: absolute;
        top: 4px;
        right: 4px;
        background: rgba(0,0,0,0.1);
        border: none;
        border-radius: 50%;
        width: 18px;
        height: 18px;
        font-size: 12px;
        line-height: 18px;
        text-align: center;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.2s;
        color: var(--text-secondary);
    }
    
    .msg-item:hover .msg-delete-btn {
        opacity: 1;
    }
    
    .msg-time { 
      font-size: 10px; 
      color: var(--text-secondary); 
      margin-top: 4px; 
      text-align: right; 
    }
    
    .ai-msg {
      background: linear-gradient(135deg, rgba(0, 113, 227, 0.1), rgba(88, 86, 214, 0.1));
      border: 1px solid rgba(0, 113, 227, 0.2);
    }

    .loading-msg {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
    }

    .loading-dots {
      display: flex;
      gap: 4px;
    }

    .loading-dots span {
      width: 6px;
      height: 6px;
      background: var(--accent-color);
      border-radius: 50%;
      animation: bounce 1.4s infinite ease-in-out;
    }

    .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
    .loading-dots span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }

    /* ========== è¾“å…¥åŒºåŸŸ ========== */
    .chat-input-area {
      display: flex;
      gap: 8px;
      margin-top: auto;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }
    
    .chat-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      outline: none;
      font-size: 14px;
      resize: none;
      min-height: 40px;
      max-height: 120px;
      overflow-y: auto;
    }
    
    .send-btn {
      padding: 0 16px;
      background: var(--accent-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.2s;
    }
    
    .send-btn:hover { opacity: 0.9; }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ========== åœ°å›¾æ ·å¼ ========== */
    #map { height: 300px; width: 100%; border-radius: 12px; margin-bottom: 20px; z-index: 1; }
    .visitor-list { flex: 1; overflow-y: auto; font-size: 13px; }
    .visitor-item { padding: 8px 0; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; }

    /* ========== å¯†ç å¼¹çª—æ ·å¼ ========== */
    .modal-overlay {
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    .modal-box {
        background: var(--bg-color);
        padding: 24px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        width: 300px;
        text-align: center;
    }
    .modal-input {
        width: 100%;
        padding: 10px;
        margin: 16px 0;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        color: var(--text-primary);
    }
    .modal-btns {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    /* ========== å“åº”å¼è®¾è®¡ ========== */
    @media (max-width: 900px) {
      .clocks-container { display: none; }
    }

    @media (max-width: 768px) {
      .hero-section { margin-top: 30px; }
      .super-search { flex-direction: column; }
      .search-select { width: 100%; padding: 12px 16px; border-right: none; border-bottom: 1px solid var(--border-color); }
      .side-panel { width: 100%; }
      .float-actions { right: 16px; bottom: 20px; }
      .float-btn { padding: 8px 12px; font-size: 12px; }
      .ai-header-btn { font-size: 13px; padding: 6px 12px; }
    }
  </style>
</head>
<body>

<!-- ========== é¡µé¢å¤´éƒ¨ ========== -->
<header>
  <div class="nav-container">
    <div class="logo-section">
      <div class="logo">å­¦æœ¯å¯¼è§ˆ.æ©å¸ˆé’±è°¦ç›Š</div>
      <button class="ai-header-btn" id="openAIBtn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
        </svg>
        AIåŠ©æ‰‹
      </button>
    </div>
    
    <div class="nav-right">
      <!-- æ—¶é’Ÿç»„ä»¶ -->
      <div class="clocks-container">
        <div class="clock-item">
          <div class="clock-face" id="clock-beijing"><div class="hand hour-hand"></div><div class="hand minute-hand"></div><div class="hand second-hand"></div><div class="center-dot"></div></div>
          <div class="clock-time" id="time-beijing">00:00</div>
          <div class="clock-label">åŒ—äº¬</div>
        </div>
        <div class="clock-item">
          <div class="clock-face" id="clock-london"><div class="hand hour-hand"></div><div class="hand minute-hand"></div><div class="hand second-hand"></div><div class="center-dot"></div></div>
          <div class="clock-time" id="time-london">00:00</div>
          <div class="clock-label">ä¼¦æ•¦</div>
        </div>
        <div class="clock-item">
          <div class="clock-face" id="clock-newyork"><div class="hand hour-hand"></div><div class="hand minute-hand"></div><div class="hand second-hand"></div><div class="center-dot"></div></div>
          <div class="clock-time" id="time-newyork">00:00</div>
          <div class="clock-label">çº½çº¦</div>
        </div>
        <div class="clock-item">
          <div class="clock-face" id="clock-tokyo"><div class="hand hour-hand"></div><div class="hand minute-hand"></div><div class="hand second-hand"></div><div class="center-dot"></div></div>
          <div class="clock-time" id="time-tokyo">00:00</div>
          <div class="clock-label">ä¸œäº¬</div>
        </div>
        <div class="clock-item">
          <div class="clock-face" id="clock-paris"><div class="hand hour-hand"></div><div class="hand minute-hand"></div><div class="hand second-hand"></div><div class="center-dot"></div></div>
          <div class="clock-time" id="time-paris">00:00</div>
          <div class="clock-label">å·´é»</div>
        </div>
        <div class="clock-item">
          <div class="clock-face" id="clock-sydney"><div class="hand hour-hand"></div><div class="hand minute-hand"></div><div class="hand second-hand"></div><div class="center-dot"></div></div>
          <div class="clock-time" id="time-sydney">00:00</div>
          <div class="clock-label">æ‚‰å°¼</div>
        </div>
      </div>

      <button class="icon-btn" id="themeToggle" style="background:none; border:none; cursor:pointer; color:var(--text-primary); padding:8px;">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      </button>
    </div>
  </div>
</header>

<!-- ========== ä¸»å†…å®¹åŒº ========== -->
<div class="hero-section">
  <div class="quote-box" id="quoteBox">"è¯»ä¹¦ä¸æ˜¯ä¸ºäº†é›„è¾©å’Œé©³æ–¥ï¼Œä¹Ÿä¸æ˜¯ä¸ºäº†è½»ä¿¡å’Œç›²ä»ï¼Œè€Œæ˜¯ä¸ºäº†æ€è€ƒå’Œæƒè¡¡ã€‚"</div>
  
  <div class="super-search">
    <select class="search-select" id="engineSelect">
      <option value="cnki">ğŸ“š çŸ¥ç½‘æœç´¢</option>
      <option value="baidu">ğŸ“• ç™¾åº¦å­¦æœ¯</option>
      <option value="google">ğŸŒ è°·æ­Œå­¦æœ¯</option>
      <option value="site">ğŸ” æœ¬ç«™æœç´¢</option>
    </select>
    <input type="text" class="search-input-main" id="mainSearchInput" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå›è½¦æœç´¢...">
    <button class="search-btn" id="searchBtn">æœç´¢</button>
  </div>
</div>

<!-- ========== åˆ†ç±»æ ‡ç­¾ ========== -->
<div class="tabs-container">
  <button class="tab-btn active" data-filter="æ€»è§ˆ">æ€»è§ˆ</button>
  <button class="tab-btn" data-filter="æ”¶è—">â­ æˆ‘çš„æ”¶è—</button>
  <button class="tab-btn" data-filter="ç»¼åˆå­¦æœ¯">ç»¼åˆå­¦æœ¯</button>
  <button class="tab-btn" data-filter="å“²å­¦">å“²å­¦</button>
  <button class="tab-btn" data-filter="ç»æµå­¦">ç»æµå­¦</button>
  <button class="tab-btn" data-filter="æ³•å­¦">æ³•å­¦</button>
  <button class="tab-btn" data-filter="æ•™è‚²å­¦">æ•™è‚²å­¦</button>
  <button class="tab-btn" data-filter="æ–‡å­¦/è¯­è¨€">æ–‡å­¦/è¯­è¨€</button>
  <button class="tab-btn" data-filter="å†å²å­¦">å†å²å­¦</button>
</div>

<!-- ========== ä¸»ç½‘æ ¼ ========== -->
<main>
  <div class="grid" id="grid"></div>
</main>

<!-- ========== æ‚¬æµ®æŒ‰é’® ========== -->
<div class="float-actions">
  <button class="float-btn ai-btn" id="openAIFloatBtn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    AIåŠ©æ‰‹
  </button>
  <button class="float-btn" id="openMapBtn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
    è®¿å®¢åœ°å›¾
  </button>
  <button class="float-btn" id="openHoleBtn">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
    å­¦æœ¯æ ‘æ´
  </button>
</div>

<!-- ========== ä¾§è¾¹é¢æ¿ ========== -->
<div class="panel-overlay" id="panelOverlay">
  <div class="side-panel">
    <div class="panel-header">
      <div class="panel-title" id="panelTitle">é¢æ¿æ ‡é¢˜</div>
      <button class="close-btn" id="closePanel" style="background:none; border:none; font-size:24px; cursor:pointer; color:var(--text-secondary);">&times;</button>
    </div>
    <div id="panelContent"></div>
  </div>
</div>

<!-- ========== å¯†ç å¼¹çª— (æ–°å¢) ========== -->
<div class="modal-overlay" id="passwordModal" style="display: none;">
  <div class="modal-box">
    <h3 style="margin-bottom: 8px;">ç®¡ç†å‘˜éªŒè¯</h3>
    <p style="font-size: 13px; color: var(--text-secondary);">è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥æ‰§è¡Œæ“ä½œ</p>
    <input type="password" id="adminPasswordInput" class="modal-input" placeholder="è¯·è¾“å…¥å¯†ç ">
    <div class="modal-btns">
      <button class="control-btn" onclick="window.closePasswordModal()">å–æ¶ˆ</button>
      <button class="control-btn" style="background: var(--accent-color); color: white; border: none;" onclick="window.submitPassword()">ç¡®è®¤</button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
  // ==================== æ•°æ®é…ç½® ====================
  const sites = ${JSON.stringify(sites)};
  
  // ==================== å·¥å…·å‡½æ•°æ¨¡å— ====================
  const Utils = {
    storage: {
      get(key, defaultValue = null) {
        try {
          const item = localStorage.getItem(key);
          return item ? JSON.parse(item) : defaultValue;
        } catch(e) { return defaultValue; }
      },
      set(key, value) {
        try { localStorage.setItem(key, JSON.stringify(value)); return true; } 
        catch(e) { return false; }
      }
    }
  };

  // ==================== æ”¶è—åŠŸèƒ½æ¨¡å— ====================
  const FavoriteManager = {
    KEY: 'academic_favorites',
    getAll() { return Utils.storage.get(this.KEY, []); },
    save(list) { Utils.storage.set(this.KEY, list); },
    toggle(name) {
      const favorites = this.getAll();
      const index = favorites.indexOf(name);
      if (index > -1) { favorites.splice(index, 1); } else { favorites.push(name); }
      this.save(favorites);
      return favorites;
    },
    has(name) { return this.getAll().includes(name); }
  };

  // ==================== AIå¯¹è¯ç®¡ç†æ¨¡å— (æ–°å¢åˆ é™¤åŠŸèƒ½) ====================
  const AIChatManager = {
    KEY: 'ai_chat_history',
    MAX_HISTORY: 100,
    getHistory() { return Utils.storage.get(this.KEY, []); },
    saveHistory(history) {
      if (history.length > this.MAX_HISTORY) { history = history.slice(-this.MAX_HISTORY); }
      Utils.storage.set(this.KEY, history);
    },
    addMessage(message) {
      const history = this.getHistory();
      history.push({ ...message, timestamp: Date.now() });
      this.saveHistory(history);
      return history;
    },
    deleteMessage(index) {
        let history = this.getHistory();
        history = history.slice(0, index);
        this.saveHistory(history);
        return history;
    },
    clearHistory() { Utils.storage.set(this.KEY, []); }
  };

  // ==================== æ—¶é’Ÿç³»ç»Ÿæ¨¡å— ====================
  const ClockSystem = {
    clocks: [
      { id: 'beijing', offset: 8, element: 'clock-beijing', timeEl: 'time-beijing' },
      { id: 'london', offset: 0, element: 'clock-london', timeEl: 'time-london' },
      { id: 'newyork', offset: -5, element: 'clock-newyork', timeEl: 'time-newyork' },
      { id: 'tokyo', offset: 9, element: 'clock-tokyo', timeEl: 'time-tokyo' },
      { id: 'paris', offset: 1, element: 'clock-paris', timeEl: 'time-paris' },
      { id: 'sydney', offset: 11, element: 'clock-sydney', timeEl: 'time-sydney' }
    ],
    init() {
      this.update();
      setInterval(() => this.update(), 1000);
    },
    update() {
      const now = new Date();
      const seconds = now.getUTCSeconds();
      const minutes = now.getUTCMinutes();
      const hours = now.getUTCHours();
      this.clocks.forEach(clock => {
        const el = document.getElementById(clock.element);
        const timeEl = document.getElementById(clock.timeEl);
        if (!el || !timeEl) return;
        const localHours = (hours + clock.offset + 24) % 24;
        const secDeg = (seconds / 60) * 360;
        const minDeg = ((minutes + seconds / 60) / 60) * 360;
        const hourDeg = ((localHours % 12 + minutes / 60) / 12) * 360;
        el.querySelector('.second-hand').style.transform = \`rotate(\${secDeg}deg)\`;
        el.querySelector('.minute-hand').style.transform = \`rotate(\${minDeg}deg)\`;
        el.querySelector('.hour-hand').style.transform = \`rotate(\${hourDeg}deg)\`;
        const timeStr = \`\${String(localHours).padStart(2, '0')}:\${String(minutes).padStart(2, '0')}:\${String(seconds).padStart(2, '0')}\`;
        timeEl.textContent = timeStr;
      });
    }
  };

  // ==================== ç«™ç‚¹æ¸²æŸ“æ¨¡å— ====================
  const SiteRenderer = {
    currentData: [], gridElement: null,
    init() {
      this.gridElement = document.getElementById('grid');
      this.render(sites);
    },
    render(data) {
      this.currentData = data;
      this.gridElement.innerHTML = '';
      if (data.length === 0) {
        this.gridElement.innerHTML = '<div style="grid-column: 1/-1; text-align:center; padding:40px; color:var(--text-secondary);">æ— åŒ¹é…ç»“æœ</div>';
        return;
      }
      data.forEach(site => this.renderCard(site));
    },
    renderCard(site) {
      const isFav = FavoriteManager.has(site.name);
      const card = document.createElement('a');
      card.className = 'card';
      card.href = site.url;
      card.target = '_blank';
      card.innerHTML = \`
        <div class="card-header">
          <div class="card-title">\${site.name}</div>
          <button class="card-fav-btn \${isFav ? 'active' : ''}" onclick="event.preventDefault(); event.stopPropagation(); SiteRenderer.toggleFav('\${site.name}')" title="æ”¶è—">
            <svg viewBox="0 0 24 24"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26"/></svg>
          </button>
        </div>
        <div class="card-level">\${site.level || 'å­¦æœ¯èµ„æº'}</div>
        <div class="card-desc">\${site.desc}</div>
        <span class="card-tag">\${site.category}</span>
      \`;
      this.gridElement.appendChild(card);
    },
    toggleFav(name) {
      FavoriteManager.toggle(name);
      this.render(this.currentData);
    }
  };

  // ==================== æœç´¢åŠŸèƒ½æ¨¡å— ====================
  const SearchEngine = {
    init() {
      const input = document.getElementById('mainSearchInput');
      const btn = document.getElementById('searchBtn');
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.search(); });
      btn.addEventListener('click', () => this.search());
    },
    search() {
      const query = document.getElementById('mainSearchInput').value.trim();
      const engine = document.getElementById('engineSelect').value;
      if (!query) return;
      const urls = {
        cnki: 'https://kns.cnki.net/kns8/defaultresult/index?kw=' + encodeURIComponent(query),
        google: 'https://scholar.google.com/scholar?q=' + encodeURIComponent(query),
        baidu: 'https://xueshu.baidu.com/s?wd=' + encodeURIComponent(query)
      };
      if (engine === 'site') { this.searchSite(query); } 
      else if (urls[engine]) { window.open(urls[engine], '_blank'); }
    },
    searchSite(query) {
      const activeFilter = document.querySelector('.tab-btn.active').dataset.filter;
      let baseData = [];
      if (activeFilter === 'æ”¶è—') {
        const f = FavoriteManager.getAll();
        baseData = sites.filter(s => f.includes(s.name));
      } else if (activeFilter !== 'æ€»è§ˆ') {
        baseData = sites.filter(s => s.category === activeFilter);
      } else { baseData = sites; }
      const filtered = baseData.filter(s => s.name.includes(query) || s.desc.includes(query));
      SiteRenderer.render(filtered);
    }
  };

  // ==================== åˆ†ç±»æ ‡ç­¾æ¨¡å— ====================
  const TabFilter = {
    init() {
      document.querySelectorAll('.tab-btn').forEach(tab => {
        tab.addEventListener('click', () => this.handleTabClick(tab));
      });
    },
    handleTabClick(tab) {
      document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const filter = tab.dataset.filter;
      let data = [];
      if (filter === 'æ€»è§ˆ') { data = sites; } 
      else if (filter === 'æ”¶è—') {
        const favorites = FavoriteManager.getAll();
        data = sites.filter(s => favorites.includes(s.name));
      } else { data = sites.filter(s => s.category === filter); }
      SiteRenderer.render(data);
    }
  };

  // ==================== é¢æ¿ç®¡ç†æ¨¡å— ====================
  const PanelManager = {
    overlay: null, titleEl: null, contentEl: null,
    init() {
      this.overlay = document.getElementById('panelOverlay');
      this.titleEl = document.getElementById('panelTitle');
      this.contentEl = document.getElementById('panelContent');
      document.getElementById('closePanel').addEventListener('click', () => this.close());
      this.overlay.addEventListener('click', (e) => { if (e.target === this.overlay) this.close(); });
    },
    open(title, content) {
      this.titleEl.innerText = title;
      this.contentEl.innerHTML = content;
      this.overlay.classList.add('active');
    },
    close() { this.overlay.classList.remove('active'); }
  };

  // ==================== AIåŠ©æ‰‹æ¨¡å— (ä¼˜åŒ–UIä¸äº¤äº’) ====================
  const AIAssistant = {
    thinkingMode: false,
    init() {
      document.getElementById('openAIBtn').addEventListener('click', () => this.openPanel());
      document.getElementById('openAIFloatBtn').addEventListener('click', () => this.openPanel());
    },
    
    openPanel() {
      const history = AIChatManager.getHistory();
      PanelManager.open("AIå­¦æœ¯åŠ©æ‰‹ ğŸ¤–", \`
        <div class="ai-chat-panel">
          <div class="thinking-mode">
            <div class="thinking-label">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              <span>æ·±åº¦æ€è€ƒ</span>
              <div class="thinking-toggle" id="thinkingToggle"></div>
            </div>
            <div class="chat-controls">
                <button class="control-btn danger" id="clearChatBtn">æ¸…ç©ºå¯¹è¯</button>
            </div>
          </div>
          <div class="ai-chat-box" id="aiChatBox"></div>
          <div class="chat-input-area">
            <textarea class="chat-input" id="aiInput" placeholder="è¾“å…¥ä½ çš„å­¦æœ¯é—®é¢˜... (æ”¯æŒå¤šè¡Œè¾“å…¥)" rows="1"></textarea>
            <button class="send-btn" id="aiSendBtn">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
          </div>
        </div>
      \`);
      this.initPanelEvents();
      this.loadHistory(history);
    },

    initPanelEvents() {
      const toggle = document.getElementById('thinkingToggle');
      toggle.addEventListener('click', () => {
        this.thinkingMode = !this.thinkingMode;
        toggle.classList.toggle('active', this.thinkingMode);
      });

      document.getElementById('clearChatBtn').addEventListener('click', () => {
          if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰AIå¯¹è¯è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
              AIChatManager.clearHistory();
              this.loadHistory([]);
          }
      });

      const input = document.getElementById('aiInput');
      input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
      });
      document.getElementById('aiSendBtn').onclick = () => this.sendMessage();
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && e.ctrlKey) { e.preventDefault(); this.sendMessage(); }
      });
      setTimeout(() => input.focus(), 100);
    },

    loadHistory(history) {
      const chatBox = document.getElementById('aiChatBox');
      if (history.length === 0) {
        chatBox.innerHTML = \`
          <div class="msg-item ai-msg">
            <div>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯Step 3.5 Flash AIåŠ©æ‰‹ï¼Œä¸“é—¨å¸®åŠ©è§£ç­”äººæ–‡ç¤¾ç§‘é¢†åŸŸçš„å­¦æœ¯é—®é¢˜ã€‚</div>
            <div style="margin-top:8px; font-size:12px; color:var(--text-secondary);">ğŸ’¡ å¼€å¯â€œæ·±åº¦æ€è€ƒæ¨¡å¼â€å¯è·å¾—æ›´è¯¦ç»†çš„åˆ†æã€‚<br>ğŸ—‘ï¸ æ‚¬åœåœ¨æ¶ˆæ¯ä¸Šå¯æ˜¾ç¤ºåˆ é™¤æŒ‰é’®ã€‚</div>
          </div>\`;
        return;
      }
      chatBox.innerHTML = '';
      history.forEach((msg, index) => {
        const deleteBtn = \`<button class="msg-delete-btn" onclick="AIAssistant.deleteMsg(\${index})">Ã—</button>\`;
        if (msg.role === 'user') {
          chatBox.innerHTML += \`<div class="msg-item"><div>\${msg.content}</div>\${deleteBtn}</div>\`;
        } else {
          chatBox.innerHTML += \`<div class="msg-item ai-msg"><div>\${msg.content}</div>\${deleteBtn}</div>\`;
        }
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    },
    
    deleteMsg(index) {
        const newHistory = AIChatManager.deleteMessage(index);
        this.loadHistory(newHistory);
    },

    async sendMessage() {
      const input = document.getElementById('aiInput');
      const message = input.value.trim();
      if (!message) return;
      const chatBox = document.getElementById('aiChatBox');
      const sendBtn = document.getElementById('aiSendBtn');
      sendBtn.disabled = true;
      
      chatBox.innerHTML += \`<div class="msg-item"><div>\${message}</div></div>\`;
      AIChatManager.addMessage({ role: 'user', content: message });
      input.value = '';
      input.style.height = 'auto';
      
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'msg-item loading-msg';
      loadingDiv.innerHTML = \`<div class="loading-dots"><span></span><span></span><span></span></div><span>\${this.thinkingMode ? 'æ·±åº¦æ€è€ƒä¸­...' : 'æ€è€ƒä¸­...'}</span>\`;
      chatBox.appendChild(loadingDiv);
      chatBox.scrollTop = chatBox.scrollHeight;

      try {
        const res = await fetch('/api/ai', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: message, thinking: this.thinkingMode })
        });
        const data = await res.json();
        chatBox.removeChild(loadingDiv);
        
        if (data.error) {
          chatBox.innerHTML += \`<div class="msg-item" style="color:#ff3b30"><div>âŒ \${data.error}</div></div>\`;
        } else {
          chatBox.innerHTML += \`<div class="msg-item ai-msg"><div>\${data.response}</div></div>\`;
          AIChatManager.addMessage({ role: 'assistant', content: data.response });
        }
        chatBox.scrollTop = chatBox.scrollHeight;
        
      } catch (e) {
        chatBox.removeChild(loadingDiv);
        chatBox.innerHTML += \`<div class="msg-item" style="color:#ff3b30"><div>âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åå†è¯•</div></div>\`;
      } finally {
        sendBtn.disabled = false;
        input.focus();
      }
    }
  };

  // ==================== å…¶ä»–åŠŸèƒ½æ¨¡å— (æ–°å¢å¯†ç ç®¡ç†) ====================
  const OtherFeatures = {
    passwordCallback: null,
    
    init() {
      this.initQuote();
      this.initTheme();
      this.initTreeHole();
      this.initMap();
    },
    
    initQuote() {
      const quotes = [
        "è¯»ä¹¦ä¸æ˜¯ä¸ºäº†é›„è¾©å’Œé©³æ–¥ï¼Œä¹Ÿä¸æ˜¯ä¸ºäº†è½»ä¿¡å’Œç›²ä»ï¼Œè€Œæ˜¯ä¸ºäº†æ€è€ƒå’Œæƒè¡¡ã€‚ â€”â€” åŸ¹æ ¹",
        "æ•™è‚²ä¸æ˜¯æ³¨æ»¡ä¸€æ¡¶æ°´ï¼Œè€Œæ˜¯ç‚¹ç‡ƒä¸€æŠŠç«ã€‚ â€”â€” å¶èŠ",
        "å†å²æ˜¯ä¸€é¢é•œå­ï¼Œä¹Ÿæ˜¯ä¸€æœ¬æ·±åˆ»çš„æ•™ç§‘ä¹¦ã€‚ â€”â€” éƒ­æ²«è‹¥",
        "å“²å­¦æ˜¯æ€è€ƒçš„æ˜¾å¾®é•œï¼Œé€è¿‡å®ƒæˆ‘ä»¬å¯ä»¥çœ‹åˆ°äº‹ç‰©çš„æœ¬è´¨ã€‚ â€”â€” æŸæ‹‰å›¾",
        "æ³•å¾‹æ˜¯äººç±»ä¸ºäº†å…±åŒåˆ©ç›Šï¼Œç”±äººç±»æ™ºæ…§éµå¾ªäººç±»ç»éªŒæ‰€ä½œå‡ºçš„æœ€åæˆæœã€‚ â€”â€” åºå¾·"
      ];
      document.getElementById('quoteBox').innerText = '"' + quotes[Math.floor(Math.random() * quotes.length)];
    },
    initTheme() {
      document.getElementById('themeToggle').addEventListener('click', () => {
        document.body.dataset.theme = document.body.dataset.theme === 'dark' ? '' : 'dark';
      });
    },
    
    async initTreeHole() {
      document.getElementById('openHoleBtn').addEventListener('click', async () => {
        PanelManager.open("å­¦æœ¯æ ‘æ´ ğŸ•³ï¸", '<div class="ai-chat-box" id="msgList"><div style="text-align:center;color:var(--text-secondary)">åŠ è½½ä¸­...</div></div><div class="chat-input-area"><input type="text" class="chat-input" id="msgInput" placeholder="è¯´ç‚¹ä»€ä¹ˆ..."><button class="send-btn" id="sendBtn">å‘ é€</button></div><div style="text-align:right; margin-top:10px;"><button class="control-btn danger" id="adminClearBtn">ğŸ—‘ï¸ ç®¡ç†å‘˜æ¸…ç©º</button></div>');
        
        try {
          const res = await fetch('/api/messages');
          const msgs = await res.json();
          const list = document.getElementById('msgList');
          list.innerHTML = '';
          msgs.forEach(m => { list.innerHTML += \`<div class="msg-item"><div>\${m.text}</div><div class="msg-time">\${m.time}</div></div>\`; });
          if(msgs.length === 0) { list.innerHTML = '<div style="text-align:center;color:var(--text-secondary)">è¿˜æ²¡æœ‰ç•™è¨€ï¼Œåšç¬¬ä¸€ä¸ªå§ï¼</div>'; }
        } catch(e) { console.error(e); }
    
        document.getElementById('sendBtn').onclick = async () => {
          const input = document.getElementById('msgInput');
          const text = input.value.trim();
          if(!text) return;
          
          // ç«‹å³æ˜¾ç¤ºç•™è¨€ï¼Œä¸ç­‰å¾…æœåŠ¡å™¨å“åº”
          const list = document.getElementById('msgList');
          const tempMsg = document.createElement('div');
          tempMsg.className = 'msg-item';
          tempMsg.innerHTML = \`<div>\${text}</div><div class="msg-time">å‘é€ä¸­...</div>\`;
          list.insertBefore(tempMsg, list.firstChild);
          
          // æ¸…ç©ºè¾“å…¥æ¡†
          input.value = '';
          
          // åœ¨åå°å‘é€åˆ°æœåŠ¡å™¨
          try {
            const res = await fetch('/api/post', { 
              method: 'POST', 
              body: JSON.stringify({ text }), 
              headers: {'Content-Type': 'application/json'} 
            });
            
            if (res.ok) {
              // æˆåŠŸåæ›´æ–°çŠ¶æ€
              tempMsg.querySelector('.msg-time').textContent = 'å·²å‘é€';
            } else {
              // å¤±è´¥ä¹Ÿä¿ç•™æ¶ˆæ¯ï¼Œä½†æ ‡è®°ä¸ºå‘é€å¤±è´¥
              tempMsg.querySelector('.msg-time').textContent = 'å‘é€å¤±è´¥ (å·²ä¿å­˜æœ¬åœ°)';
              tempMsg.style.border = '1px dashed #ff3b30';
            }
          } catch (error) {
            // ç½‘ç»œé”™è¯¯ä¹Ÿä¿ç•™æ¶ˆæ¯
            tempMsg.querySelector('.msg-time').textContent = 'ç½‘ç»œé”™è¯¯ (å·²ä¿å­˜æœ¬åœ°)';
            tempMsg.style.border = '1px dashed #ff3b30';
          }
        };
        
        document.getElementById('adminClearBtn').onclick = () => {
            window.showPasswordModal((password) => {
                this.adminClearMessages(password);
            });
        };
      });
    },
    
    async adminClearMessages(password) {
        try {
            const res = await fetch('/api/admin/clear-messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await res.json();
            if (data.success) {
                alert('ç•™è¨€å·²æ¸…ç©º');
                this.initTreeHole(); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert('æ“ä½œå¤±è´¥: ' + (data.error || 'æœªçŸ¥é”™è¯¯'));
            }
        } catch (e) {
            alert('ç½‘ç»œé”™è¯¯');
        }
    },

    async initMap() {
      document.getElementById('openMapBtn').addEventListener('click', async () => {
        PanelManager.open("å…¨çƒè®¿å®¢è¶³è¿¹ ğŸŒ", '<div id="map"></div><div class="visitor-list" id="visitorList"><div style="text-align:center;color:var(--text-secondary)">æ­£åœ¨å®šä½...</div></div>');
        const map = L.map('map').setView([35, 105], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '' }).addTo(map);
        try {
          const res = await fetch('/api/visit');
          const data = await res.json(); 
          L.marker([data.lat, data.lon]).addTo(map).bindPopup(\`æ¥è‡ª: \${data.city}, \${data.country}\`).openPopup();
          document.getElementById('visitorList').innerHTML = \`<div class="visitor-item"><span>å½“å‰è®¿å®¢</span><span>\${data.city}, \${data.country}</span></div>\`;
        } catch(e) { console.error(e); }
      });
    }
  };
  
  // ==================== å…¨å±€å¯†ç å¼¹çª—å‡½æ•° ====================
  window.showPasswordModal = (callback) => {
      const modal = document.getElementById('passwordModal');
      const input = document.getElementById('adminPasswordInput');
      modal.style.display = 'flex';
      input.value = '';
      OtherFeatures.passwordCallback = callback;
      input.focus();
  };
  
  window.closePasswordModal = () => {
      const modal = document.getElementById('passwordModal');
      modal.style.display = 'none';
      OtherFeatures.passwordCallback = null;
  };
  
  window.submitPassword = () => {
      const input = document.getElementById('adminPasswordInput');
      const password = input.value;
      if (OtherFeatures.passwordCallback) {
          OtherFeatures.passwordCallback(password);
      }
      window.closePasswordModal();
  };
  
  // ç›‘å¬å›è½¦æäº¤å¯†ç 
  document.getElementById('adminPasswordInput').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
          window.submitPassword();
      }
  });

  // ==================== åº”ç”¨åˆå§‹åŒ– ====================
  const App = {
    init() {
      ClockSystem.init();
      SiteRenderer.init();
      SearchEngine.init();
      TabFilter.init();
      PanelManager.init();
      AIAssistant.init();
      OtherFeatures.init();
    }
  };
  App.init();
</script>
</body>
</html>
    `;

    return new Response(htmlContent, {
      headers: { 'content-type': 'text/html; charset=utf-8' },
    });
  },
};
